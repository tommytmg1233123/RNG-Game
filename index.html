import React, { useEffect, useRef, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { motion } from "framer-motion";

// --- CONFIG ---

const RARITIES = [
  { name: "Common", chance: 60, glow: "shadow-none" },
  { name: "Uncommon", chance: 25, glow: "shadow-[0_0_25px_rgba(0,255,0,0.6)]" },
  { name: "Rare", chance: 10, glow: "shadow-[0_0_25px_rgba(0,150,255,0.7)]" },
  { name: "Ultra Rare", chance: 4.9, glow: "shadow-[0_0_30px_rgba(180,0,255,0.8)]" },
  { name: "Mythic", chance: 0.1, glow: "shadow-[0_0_40px_rgba(255,215,0,1)]" },
  { name: "Divine", chance: 0.01, glow: "shadow-[0_0_45px_rgba(255,255,255,1)]" }
];

// Hundreds of meme placeholders (replace URLs with real ones if wanted)
const MEMES = Array.from({ length: 300 }).map((_, i) => {
  const rarity = weightedRandomRarity();
  return {
    id: i,
    name: `Meme #${i + 1}`,
    img: `https://picsum.photos/seed/meme${i}/300/300`,
    rarity
  };
});

function weightedRandomRarity() {
  const total = RARITIES.reduce((a, r) => a + r.chance, 0);
  let rand = Math.random() * total;
  for (const r of RARITIES) {
    if (rand < r.chance) return r;
    rand -= r.chance;
  }
  return RARITIES[0];
}

function weightedRandomMeme() {
  const roll = Math.random() * 100;
  let cumulative = 0;
  for (const rarity of RARITIES) {
    cumulative += rarity.chance;
    if (roll <= cumulative) {
      const pool = MEMES.filter(m => m.rarity.name === rarity.name);
      return pool[Math.floor(Math.random() * pool.length)] || MEMES[0];
    }
  }
  return MEMES[0];
}

export default function MemeWheelApp() {
  const [rotation, setRotation] = useState(0);
  const [spinning, setSpinning] = useState(false);
  const [currentMeme, setCurrentMeme] = useState(null);
  const [inventory, setInventory] = useState([]);
  const [showInventory, setShowInventory] = useState(false);
  const [showLeaderboard, setShowLeaderboard] = useState(false);

  const spinSoundRef = useRef(null);

  // --- LOAD SAVE ---
  useEffect(() => {
    const savedInv = localStorage.getItem("memeInventory");
    if (savedInv) setInventory(JSON.parse(savedInv));
  }, []);

  // --- SAVE ---
  useEffect(() => {
    localStorage.setItem("memeInventory", JSON.stringify(inventory));
  }, [inventory]);

  const spin = () => {
    if (spinning) return;
    setSpinning(true);

    if (spinSoundRef.current) {
      spinSoundRef.current.currentTime = 0;
      spinSoundRef.current.play();
    }

    const meme = weightedRandomMeme();

    const extraSpins = 8 + Math.random() * 4; // longer spin
    const degrees = extraSpins * 360 + Math.random() * 360;

    const newRotation = rotation + degrees; // ALWAYS same direction

    setRotation(newRotation);

    setTimeout(() => {
      setCurrentMeme(meme);
      setInventory(prev => {
        if (!prev.find(p => p.id === meme.id)) return [...prev, meme];
        return prev;
      });
      setSpinning(false);
    }, 4500); // longer spin duration
  };

  const sortedInventory = [...inventory].sort((a, b) => {
    return (
      RARITIES.findIndex(r => r.name === b.rarity.name) -
      RARITIES.findIndex(r => r.name === a.rarity.name)
    );
  });

  return (
    <div className="min-h-screen bg-neutral-950 text-white flex">

      {/* Sounds */}
      <audio ref={spinSoundRef} src="/sounds/spin.mp3" preload="auto" />

      {/* Left Sidebar */}
      <div className="w-40 p-4 flex flex-col gap-3">
        <Button onClick={() => setShowLeaderboard(true)}>Leaderboard</Button>
        <Button onClick={() => setShowInventory(true)}>Inventory</Button>
      </div>

      {/* Main */}
      <div className="flex-1 flex flex-col items-center justify-center gap-6">

        <motion.div
          animate={{ rotate: rotation }}
          transition={{ duration: 4.5, ease: [0.1, 0.7, 0.2, 1] }}
          className="w-72 h-72 rounded-full border-4 border-white flex items-center justify-center bg-neutral-800"
        >
          SPIN
        </motion.div>

        <Button onClick={spin} disabled={spinning} className="text-lg px-10 py-6">
          {spinning ? "Spinning..." : "Spin"}
        </Button>

        {currentMeme && (
          <Card className={`w-64 ${currentMeme.rarity.glow}`}>
            <CardContent className="p-3 flex flex-col items-center gap-2">
              <img src={currentMeme.img} className="rounded-xl" />
              <div>{currentMeme.name}</div>
              <div className="text-sm opacity-70">{currentMeme.rarity.name}</div>
            </CardContent>
          </Card>
        )}

      </div>

      {/* Inventory Modal */}
      {showInventory && (
        <div className="fixed inset-0 bg-black/80 p-10 overflow-auto">
          <Button onClick={() => setShowInventory(false)}>Close</Button>
          <div className="grid grid-cols-4 gap-4 mt-6">
            {sortedInventory.map(m => (
              <Card key={m.id} className={m.rarity.glow}>
                <CardContent className="p-2">
                  <img src={m.img} className="rounded-lg" />
                  <div className="text-xs">{m.rarity.name}</div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* Leaderboard Modal */}
      {showLeaderboard && (
        <div className="fixed inset-0 bg-black/80 p-10">
          <Button onClick={() => setShowLeaderboard(false)}>Close</Button>
          <div className="mt-6 text-lg">Coming soon (connect to backend later)</div>
        </div>
      )}

    </div>
  );
}
